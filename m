From: Chris Packham <judge.packham@gmail.com>
Subject: Re: [bug (maybe)] Applying patch with '---'
Date: Wed, 1 Apr 2015 21:06:43 +1300
Message-ID: <CAFOYHZDYcF0=kH=L2CZ5=4DBUaGoJihVE9J=s=uuoJQhGGd5yA@mail.gmail.com>
References: <CAFOYHZC6Qd9wkoWPcTJDxAs9u=FGpHQTkjE-guhwkya0DRVA6g@mail.gmail.com>
	<xmqqy4mcmkt2.fsf@gitster.dls.corp.google.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Cc: GIT <git@vger.kernel.org>
To: Junio C Hamano <gitster@pobox.com>
X-From: git-owner@vger.kernel.org Wed Apr 01 10:07:22 2015
Return-path: <git-owner@vger.kernel.org>
Envelope-to: gcvg-git-2@plane.gmane.org
Received: from vger.kernel.org ([209.132.180.67])
	by plane.gmane.org with esmtp (Exim 4.69)
	(envelope-from <git-owner@vger.kernel.org>)
	id 1YdDgC-0001Ru-WE
	for gcvg-git-2@plane.gmane.org; Wed, 01 Apr 2015 10:07:17 +0200
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1752413AbbDAIHG (ORCPT <rfc822;gcvg-git-2@m.gmane.org>);
	Wed, 1 Apr 2015 04:07:06 -0400
Received: from mail-pa0-f50.google.com ([209.85.220.50]:36676 "EHLO
	mail-pa0-f50.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1752012AbbDAIGq (ORCPT <rfc822;git@vger.kernel.org>);
	Wed, 1 Apr 2015 04:06:46 -0400
Received: by padcy3 with SMTP id cy3so45027442pad.3
        for <git@vger.kernel.org>; Wed, 01 Apr 2015 01:06:43 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20120113;
        h=mime-version:in-reply-to:references:date:message-id:subject:from:to
         :cc:content-type;
        bh=PEuVrWLp4WQezr0h2Do16CtydwUhK6j3GPn0fdK4HX4=;
        b=Z3WskNz0Y2C+CSAwyX4vHx1dzw+0myVV0sv5NSHQUC5IHRDP30baL1kU7gpoyeuTdz
         aJHOa0bivpKEi6XGd8S3SFsiokQesRz1E6OMz6tGWSlvOuQJzghckQmiowYbpnbZJ77e
         NOsrKcdAAwsnrMsVkr1kF96bbIobFmfroA94tpOT5oyBkhp6oIzIIzzEVXax7M9r1kml
         /CYJFqmMDpFLPATjmL1JHMhyfzswLZhw+/p7ur5omKhREurBdp76hSaLFGPt0CAo4Ve/
         NXIxui0S3wx73yYqLTTEWAI/CZTf1E6F/OpAziDsWnNpE0wnNHioh56hv0dzERM1TMm+
         wRaA==
X-Received: by 10.70.47.102 with SMTP id c6mr17786234pdn.24.1427875603274;
 Wed, 01 Apr 2015 01:06:43 -0700 (PDT)
Received: by 10.70.0.171 with HTTP; Wed, 1 Apr 2015 01:06:43 -0700 (PDT)
In-Reply-To: <xmqqy4mcmkt2.fsf@gitster.dls.corp.google.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <http://permalink.gmane.org/gmane.comp.version-control.git/266594>

On Wed, Apr 1, 2015 at 7:20 PM, Junio C Hamano <gitster@pobox.com> wrote:
> Chris Packham <judge.packham@gmail.com> writes:
>
>> So I was just sent a patch generated with 'git format-patch' that 'git
>> am' fails to apply correctly. It applies but part of the commit
>> message is lost.
>>
>> The problem is that the commit message has lines like
>>
>> --- Foo happened
>>     did some things to handle Foo
>> --- Bar happened
>>     Still processing update from Foo which led to a crash
>>
>> git mailinfo seems to discard everything after the first '--- Blah'.
>
> Yes, this is well known.  So is a line that begins with "diff --git"
> makes mailinfo to guess that it is the end of the log message.
>

So it looks like code in mailinfo.c to handle

  --- a/file
  +++ b/file

Also interprets

  --- Blah
  more text

as the start of the patch portion. Perhaps mailinfo could search for
both the --- and +++ lines before deciding it's the patch portion has
started. Or search for "diff -" first and work backwards towards to
drop text up to the "---".

>> ... I know git
>> mailinfo shouldn't handle garbage input but I guess the problem I have
>> is that the patch was generated by git format-patch ...
>
> Whatever message you write format-patch emits without escaping, so
> "patch was generated by format-patch" does not guarantee anything,
> unfortunately.  A related similar issue is that a line that begins
> with "From " may be corrupted into a line that begins with ">From "
> by the time the message hits your mailbox.  These are unfortunately
> something you have to know and long-time users learned to avoid
> doing so unconsciously ;-).

So perhaps the newer users need some training wheels built into
format-patch :). It'd actually annoy me if it was too intrusive as I
actually use --- as a light weight alternative to git-notes for
commentary I want to include with a patch submission.  But a message
saying "if you send this verbatim commit message text will be lost"
would at least let the user know that something needs attention .
