From: Dan Kegel <dank@kegel.com>
Subject: Patches generated by "git format-patch -M -B" can't be applied with
 "git apply"?
Date: Mon, 14 Sep 2015 15:21:11 -0700
Message-ID: <CAPF-yOb4dRWGLmL==x8=ifvU4Znsut9XQWMLPxBCPq7TzgJ84A@mail.gmail.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
To: git@vger.kernel.org
X-From: git-owner@vger.kernel.org Tue Sep 15 00:21:35 2015
Return-path: <git-owner@vger.kernel.org>
Envelope-to: gcvg-git-2@plane.gmane.org
Received: from vger.kernel.org ([209.132.180.67])
	by plane.gmane.org with esmtp (Exim 4.69)
	(envelope-from <git-owner@vger.kernel.org>)
	id 1Zbc7y-0003P8-1g
	for gcvg-git-2@plane.gmane.org; Tue, 15 Sep 2015 00:21:34 +0200
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1751480AbbINWVO (ORCPT <rfc822;gcvg-git-2@m.gmane.org>);
	Mon, 14 Sep 2015 18:21:14 -0400
Received: from mail-lb0-f170.google.com ([209.85.217.170]:33479 "EHLO
	mail-lb0-f170.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1751234AbbINWVN (ORCPT <rfc822;git@vger.kernel.org>);
	Mon, 14 Sep 2015 18:21:13 -0400
Received: by lbbvu2 with SMTP id vu2so2874287lbb.0
        for <git@vger.kernel.org>; Mon, 14 Sep 2015 15:21:11 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20120113;
        h=mime-version:sender:date:message-id:subject:from:to:content-type;
        bh=wkWBuxPLyDPgI9hkuaoeGp0VACX7TNH/IuA90ayeqLw=;
        b=uLg/jt0ps7Gi+R3dF3RGvQ95DQnIxU69ngE1L/q9EOyCfy8zmMfbPU+kmQIBzkq+Hx
         y5+eKcbjCNyg+CgN265TFw8S+AWy4CyHYJ9y7F0b8ykHt89hmez2mClhhKW3N3CzKIyJ
         zAnnzCiEPBOdGNA95+oAwdIQX12Fnq2q2ts7ezUNWZMm/lW2i4UWrgxGxGAQVQC+Bk69
         iSlOv+sBrT/wQbEt3HhKBAgIikSCdo/g9OFGANdLuI6ZHtuhdBWtKTPgTmJ3YC5GBavg
         6DC3F3YV/h/uaMrVjgWzfVrvdtP8WEhQb/qCSqWMuFiW7BnUvrt5ojHv4cNvRLSgQ650
         ZL8w==
X-Received: by 10.152.44.232 with SMTP id h8mr17043736lam.104.1442269271416;
 Mon, 14 Sep 2015 15:21:11 -0700 (PDT)
Received: by 10.112.17.168 with HTTP; Mon, 14 Sep 2015 15:21:11 -0700 (PDT)
X-Google-Sender-Auth: nXsaJhzJSsOqPdzNOlzCQjz-Kis
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <http://permalink.gmane.org/gmane.comp.version-control.git/277870>

A bot I wrote uses 'git format-patch -M -B' to generate a patch
to send off to be applied with 'git am' on a remote machine.
Alas, renames do not appear to work; git am rejects them with
 error: file2: already exists in working directory
This happens both with the git that ships with Ubuntu 14.04
and with master ( git version 2.6.0.rc1.16.g1962994 ).

I noticed that git has a similar test case already,
t4130-apply-criss-cross-rename.sh
so I munged that to reproduce the error,
http://kegel.com/git/t4154-apply-half-criss-cross-rename.sh.txt
Running
 ./t4154-apply-half-criss-cross-rename.sh -v
fails for me reliably with
 error: file2: already exists in working directory
with either v2.6.0-rc2 or random local git on local Mac and Linux.
is this behavior indeed a bug, or am I breaking some rule?
Thanks!
- Dan

p.s. Here's the test case inline, but if email munges whitespace,
the url above might be better.

#!/bin/sh

test_description='git apply handling half-criss-cross rename patch.'
. ./test-lib.sh

create_file() {
        cnt=0
        while test $cnt -le 100
        do
                cnt=$(($cnt + 1))
                echo "$2" >> "$1"
        done
}

test_expect_success 'setup' '
        create_file file1 "File1 contents" &&
        create_file file2 "File2 contents" &&
        git add file1 file2 &&
        git commit -m 1
'

test_expect_success 'half criss-cross rename' '
        mv file1 file2 &&
        git rm file1 &&
        git add file2 &&
        git commit -m 2
'

test_expect_success 'diff -M -B' '
        git format-patch -M -B HEAD^ --stdout > diff &&
        git reset --hard HEAD^
'

test_expect_success 'apply' '
        git apply --check diff
'

test_done
