From: Lars Hjemli <hjemli@gmail.com>
Subject: Re: [PATCH] clean cached refs when calling set_git_dir()
Date: Thu, 10 Mar 2011 18:14:17 +0100
Message-ID: <AANLkTikrTva2KFxh0O=Ryn1zWZR2rjCSVkGjHQ0w0xL0@mail.gmail.com>
References: <1299770345-32055-1-git-send-email-plenz@cis.fu-berlin.de>
	<AANLkTik1HMQqKc98AF-6DTGJgrk8HOjZTimGnK-XBv-q@mail.gmail.com>
	<20110310160948.GL15960@plenz.com>
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Cc: Nguyen Thai Ngoc Duy <pclouds@gmail.com>, git@vger.kernel.org,
	cgit@hjemli.net
To: Julius Plenz <plenz@cis.fu-berlin.de>
X-From: git-owner@vger.kernel.org Thu Mar 10 18:14:24 2011
Return-path: <git-owner@vger.kernel.org>
Envelope-to: gcvg-git-2@lo.gmane.org
Received: from vger.kernel.org ([209.132.180.67])
	by lo.gmane.org with esmtp (Exim 4.69)
	(envelope-from <git-owner@vger.kernel.org>)
	id 1PxjRP-0005Tz-Rm
	for gcvg-git-2@lo.gmane.org; Thu, 10 Mar 2011 18:14:24 +0100
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1751946Ab1CJROT (ORCPT <rfc822;gcvg-git-2@m.gmane.org>);
	Thu, 10 Mar 2011 12:14:19 -0500
Received: from mail-vx0-f174.google.com ([209.85.220.174]:52852 "EHLO
	mail-vx0-f174.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1751606Ab1CJROS (ORCPT <rfc822;git@vger.kernel.org>);
	Thu, 10 Mar 2011 12:14:18 -0500
Received: by vxi39 with SMTP id 39so1697913vxi.19
        for <git@vger.kernel.org>; Thu, 10 Mar 2011 09:14:17 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:mime-version:in-reply-to:references:date
         :message-id:subject:from:to:cc:content-type;
        bh=6kKBTk2NU73XoBteYzRk7eRjhZOxdJGKPZ41CgOERa4=;
        b=aXEz5kG4cdIW+2w/jl3tEO/BkiuNA8tcvA2tUo5H87BsHHLwAMlJa9qQ4RM2fMx4Yw
         QzLm0b9mxq1/UWRx3BNHlfP5GzEVAC1FO6WvOUVCXDhymTxBcqXWql/HsEF0K1nqvHki
         irKv3D062Hsxy5gilZrxTKJOzom1iSovFRLcM=
DomainKey-Signature: a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=mime-version:in-reply-to:references:date:message-id:subject:from:to
         :cc:content-type;
        b=mlM40FWtEfR/V+dZ60WybdT6zWOzJp79wTAyD8++YS8Lo5ywjOX/hh9zK7MmzgYR8i
         KbLH4BZL749qyKom7Eialc7GT01BG8DIMgxVX21CTbwhQ3DZ3vONqnbehUaAJAhUR5Gv
         4HSqomb32OOv6u8ylcRfyf4DYeWRSsjGv5jZ8=
Received: by 10.52.172.208 with SMTP id be16mr3706713vdc.272.1299777257711;
 Thu, 10 Mar 2011 09:14:17 -0800 (PST)
Received: by 10.52.160.130 with HTTP; Thu, 10 Mar 2011 09:14:17 -0800 (PST)
In-Reply-To: <20110310160948.GL15960@plenz.com>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <http://permalink.gmane.org/gmane.comp.version-control.git/168834>

On Thu, Mar 10, 2011 at 17:09, Julius Plenz <plenz@cis.fu-berlin.de> wrote:
> * Nguyen Thai Ngoc Duy <pclouds@gmail.com> [2011-03-10 17:00]:
>> On Thu, Mar 10, 2011 at 10:19 PM, Julius Plenz <plenz@cis.fu-berlin.de> wrote:
>> > If you use libgit.a to perform reference resolutions on two or more
>> > repositories that contain packed refs, cached_refs will store the packed
>> > refs for the first repository to contain a packed-refs file only.
>>
>> If you use libgit.a to do anything on more than one repository, you
>> get a lot more messed up that just that. Spawning a new process or
>> accessing with libgit2 may be safer. Why do you want to do that in the
>> first place?
>
> I was working on the cgit repository browser, where you have to peek
> into several repositories to create the overview page. Since cgit
> links to libgit.a I fixed the bug there. Not sure if that's the proper
> way to do it, though...

I never got around to answer your earlier email about this, but here
is what I would have said ;)

Since libgit.a doesn't work with multiple repos [1], cgit supports the
use of an "agefile" (that's the option name in cgitrc) to obtain the
last commit-date per repo.

The content of such an agefile can be generated by a command like the
following in one (or more) of your git hooks:

  git for-each-ref --sort=-authordate --format='%(authordate:iso8601)' --count=1

Hth.
-- 
larsh

[1] Even if libgit.a did support working with multiple repos in a
single run, I probably would avoid this particular usage since it is
bound to perform badly when lots of repos are involved (like on
cgit.freedesktop.org), and even more so when the list is sorted by
idle-time. Simply reading a small textfile per repo is much faster.
