Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-3.1 required=3.0 tests=AWL,BAYES_00,
	FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
	MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI,T_RP_MATCHES_RCVD shortcircuit=no
	autolearn=ham autolearn_force=no version=3.4.0
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 480821F404
	for <e@80x24.org>; Fri,  6 Apr 2018 19:31:52 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1751642AbeDFTbt (ORCPT <rfc822;e@80x24.org>);
        Fri, 6 Apr 2018 15:31:49 -0400
Received: from mout.gmx.net ([212.227.17.21]:35029 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1751329AbeDFTbt (ORCPT <rfc822;git@vger.kernel.org>);
        Fri, 6 Apr 2018 15:31:49 -0400
Received: from [192.168.0.129] ([37.201.195.115]) by mail.gmx.com (mrgmx102
 [212.227.17.168]) with ESMTPSA (Nemesis) id 0LosFD-1eayga0Ufr-00gmTV; Fri, 06
 Apr 2018 21:31:39 +0200
Date:   Fri, 6 Apr 2018 21:31:22 +0200 (DST)
From:   Johannes Schindelin <johannes.schindelin@gmx.de>
X-X-Sender: virtualbox@MININT-6BKU6QN.europe.corp.microsoft.com
To:     git@vger.kernel.org
cc:     Junio C Hamano <gitster@pobox.com>, Jeff King <peff@peff.net>
Subject: [PATCH] t5404: relax overzealous test
Message-ID: <958ee6f006aba0c67c8e064d31206e3e68a1cc49.1523043053.git.johannes.schindelin@gmx.de>
User-Agent: Alpine 2.21.1 (DEB 209 2017-03-23)
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
X-Provags-ID: V03:K1:V12/dXHzy+EC3x3wZsG25iPENdBqRbIPFRnGzTHjnhDQSkCmE6C
 7wGQYImF3qjPlFU+bq+8LCipd1dgcWysPgp8BRB1wxsdAOCLuOgEJIl22+dRt26tkv+jF+I
 4azh2RqqpEOP3d1weAyGdTc9oTre+7GRyUlhBahkjAtRVMcHANCMhv/rbdaenvXOzFRVY49
 71asuZBlUpEQ1xzoY/POw==
X-UI-Out-Filterresults: notjunk:1;V01:K0:Q2E9Gsn0mFg=:klVCVlG1dppMc7P1BdXEqI
 fLn10vat62+Pe2qV5f0BkLAH7EV/kjYaHKTq3nG4dNWszEIMEhL08+sswHizmVstj4aTSx+MB
 RpKcnxGiLr2IrYTRegYE65JK4Ow7pmId+5jbjwCrRlwpY7hkZrFSb4iE3sDHx3l2rMxS+7zsV
 eks0CgujvbWN6bGfaY1NdNMGLtwVKL+EhaZMuAT2Z9FSlqVPx/DjF1114xIdfWWI3iF8xTjDV
 DvdMofwpy3cz8T6D81HqBPD9tTKNTsZucam1CfjIReEaPyWcl1MCkr3OKTkP0P2I3BbtS5a8+
 PFAFSyg5b39WXFdT68r6CmF18rVo+rtD0tgLw5t6i2ziyOk0GX1OpDFJe0BjSn6FnPkjLh59F
 1aBCVPN13e3VtCj2kB7ZUTQRAtoFBWLwC4asaZmOnJKcA5tH4uqZmOmZqTtBb9xEkzbiT3EbS
 oaLEZdMuMbUaaGeqV+J+GYL3vyCFmySPz9Jom1kDKAfKY8VeJhAXVe0480OKH/s+20Mr4mra/
 BD2MnG4cHQWC15JiysC4KFMr35ZuhmOz6xaZ75oQisw3Hh4Rtbaeoj8210W9akyuspn4qLzpN
 1i9nU9Jj3dYcn3cmCcpMCC2Ffq9+Iy2atwjwucYhbk3WCsGUE4O8m8q6Ri9u0+DXAkBxdtP+1
 +hnUyKHOEqeDn96xxuscVXa4YTX7PTbvDY02ojPGLKZG95QLmZ6xAFlw+jjhHZ2Jx4RUQ3Ofq
 mz9AVv1I8OKxIXh6lAJi7GctTNpPllhgAcPM9y9ySwEf7kflUVsKNV3DjF9CqpQhMgKC4SwV1
 YJKbO9xjLbNJ7KFsqQma+RsgddPE6EKi+rZdPku7ZWIsJB7qt7lgrgsgY+EleEs/IeApG2H
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org

In 0b294c0abf0 (make deleting a missing ref more quiet, 2008-07-08), we
added a test to verify that deleting an already-deleted ref does not
show an error.

Our test simply looks for the substring 'error' in the output of the
`git push`, which might look innocuous on the face of it.

Suppose, however, that you are a big fan of whales. Or even better: your
IT administrator has a whale of a time picking cute user names, e.g.
referring to you (due to your like of India Pale Ales) as "one of the
cuter rorquals" (see https://en.wikipedia.org/wiki/Rorqual to learn a
thing or two about rorquals) and hence your home directory becomes
/home/cuterrorqual. If you now run t5404, it fails! Why? Because the
test calls `git push origin :b3` which outputs:

    To /home/cuterrorqual/git/t/trash directory.t5404-tracking-branches/.
     - [deleted]         b3

Note how there is no error displayed in that output? But of course
"error" is a substring of "cuterrorqual". And so that `grep error
output` finds something.

This bug was not, actually, caught having "error" as a substring of the
user name but while working in a worktree called "colorize-push-errors",
whose name was part of that output, too, suggesting that not even
testing for the *word* `error` via `git grep -w error output` would fix
the underlying issue.

This patch chooses instead to look for the prefix "error:" at the
beginning of the line, so that there can be no ambiguity that any catch
was indeed a message generated by Git's `error_builtin()` function.

Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
---
Published-As: https://github.com/dscho/git/releases/tag/fix-t5404-error-v1
Fetch-It-Via: git fetch https://github.com/dscho/git fix-t5404-error-v1
 t/t5404-tracking-branches.sh | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/t/t5404-tracking-branches.sh b/t/t5404-tracking-branches.sh
index 2b8c0bac7db..2762f420bc2 100755
--- a/t/t5404-tracking-branches.sh
+++ b/t/t5404-tracking-branches.sh
@@ -56,7 +56,7 @@ test_expect_success 'deleted branches have their tracking branches removed' '
 test_expect_success 'already deleted tracking branches ignored' '
 	git branch -d -r origin/b3 &&
 	git push origin :b3 >output 2>&1 &&
-	! grep error output
+	! grep "^error: " output
 '
 
 test_done

base-commit: 468165c1d8a442994a825f3684528361727cd8c0
-- 
2.17.0.windows.1.4.g7e4058d72e3
