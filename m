Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-3.3 required=3.0 tests=AWL,BAYES_00,
	FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
	MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI shortcircuit=no autolearn=ham
	autolearn_force=no version=3.4.0
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 47EC21F424
	for <e@80x24.org>; Wed, 25 Apr 2018 12:29:46 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1754012AbeDYM3n (ORCPT <rfc822;e@80x24.org>);
        Wed, 25 Apr 2018 08:29:43 -0400
Received: from mout.gmx.net ([212.227.17.20]:42331 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1753723AbeDYM3g (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 25 Apr 2018 08:29:36 -0400
Received: from localhost.localdomain ([37.201.195.116]) by mail.gmx.com
 (mrgmx103 [212.227.17.168]) with ESMTPSA (Nemesis) id
 0MBFBB-1f3qtI0QVx-00AJ24; Wed, 25 Apr 2018 14:29:29 +0200
From:   Johannes Schindelin <johannes.schindelin@gmx.de>
To:     git@vger.kernel.org
Cc:     Johannes Schindelin <johannes.schindelin@gmx.de>,
        Junio C Hamano <gitster@pobox.com>,
        Jacob Keller <jacob.keller@gmail.com>,
        Stefan Beller <sbeller@google.com>,
        Philip Oakley <philipoakley@iee.org>,
        Eric Sunshine <sunshine@sunshineco.com>,
        Phillip Wood <phillip.wood@dunelm.org.uk>,
        Igor Djordjevic <igor.d.djordjevic@gmail.com>,
        Johannes Sixt <j6t@kdbg.org>,
        Sergey Organov <sorganov@gmail.com>,
        =?UTF-8?q?Martin=20=C3=85gren?= <martin.agren@gmail.com>
Subject: [PATCH v9 12/17] sequencer: make refs generated by the `label` command worktree-local
Date:   Wed, 25 Apr 2018 14:29:16 +0200
Message-Id: <7db22d85599229df85b9f48025c7983d376651d2.1524659287.git.johannes.schindelin@gmx.de>
X-Mailer: git-send-email 2.17.0.windows.1.33.gfcbb1fa0445
MIME-Version: 1.0
In-Reply-To: <cover.1524659287.git.johannes.schindelin@gmx.de>
References: <cover.1524306546.git.johannes.schindelin@gmx.de> <cover.1524659287.git.johannes.schindelin@gmx.de>
Fcc:    Sent
Content-Type: text/plain; charset=UTF-8
X-Provags-ID: V03:K1:Kj+XfrEWXTDrA8c4NIe26XZbTYG8BEi8tCsZogz2I/6FcMs6OiT
 obTlEFj7u00Fw7CfrLaYvK18IgOh/A4Zi63Ai4EfKHfFMZCdM0FfA9IRLFIbQFofBhaOmOg
 fYTE4i/wLfExZ4v3Xjo7h27JdEBoqN9Gi9w/0JmKLhU3aEeBPuDR8QWBpFTWpRGwwo+a4Z7
 I2NE+SJxni3k//SRmSm3A==
X-UI-Out-Filterresults: notjunk:1;V01:K0:Xm/lbLWV79Q=:4rFHNIFyHN89bQK/RjKEso
 XUggj5hG4HCpBW/WUOFiSVcPPE/rjA/xqYhEUXQbxosv0v5lk73G8wnCB5fOWFq3WpgrGV8WX
 klz7oUAp1nWz7+VqO99vyzs2/4+el4VMV6/irLzD05iuo0IlbpRfiEEdPTIq+RsRoWEx4FUlA
 tOd9mff+7yi6ymbuggTXkz3K5sc12k6MMYdLTHjEB8hsNM4WIvNP01vmmt0JU2Uvp8euTFkd2
 U4RSQyHiJvjlZFuh9SjhLuF1ijLnfCQhT64fbEIfS0TqNy4LcaCLM5VXcpCWRH+yEK5bI4u0v
 lYJ4mG5Hgy4l5+ENE/fI+2kG5kW6T9VXFyRDaUKfJBcapD5GnRtDf1A4xgVcPQN+ji5ju08aj
 wT4bnpIGUVdgCo+bNIfBonxlxMGZq65AlRLfk9sKZ3Ig3K9P8KNHl38KYzZDtICCTfySNQhn0
 tWO2cj6C/wxTSoj/4GGHS7Pz9/bC4ZItZQMi8M/ZexsU9XROHeJ3EBcVRTq4d3kT0xZ2N+7kG
 wuB5vH8/hHTTSlUqWoJ67ZgeWV4Wq1oDVyJJmbb1cqEDc512isIvjWzhDheiqQjfWzofStqjG
 VSjBjVLa9wGxm62C7VWcClvTg8cM1iM5us4HtBNAy54msu2oO4wvTL3vp7NrJg5+8sgabVFn+
 7Ii8JoWTccgvInMPQbpu/buZ4itILZwytrG1JzYBoeuCFPj6nUQ1Q+da/+NugWZbtR2kUS8wm
 64iDkQl40cgujxF3Y4XLpKsK8qq7U8jou/Wjf4qltEKcwD7II2pHuYERTD2wNWCbFz5MjYQDB
 xFAzeyNxLWam5vvw7gp/5IK83c1aDlXiZLv1bmdgHQPWug1uujizlXp26n8EA4hLl0whLmA
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org

This allows for rebases to be run in parallel in separate worktrees
(think: interrupted in the middle of one rebase, being asked to perform
a different rebase, adding a separate worktree just for that job).

Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
---
 refs.c                   |  3 ++-
 t/t3430-rebase-merges.sh | 14 ++++++++++++++
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/refs.c b/refs.c
index 8b7a77fe5ee..f61ec58d1df 100644
--- a/refs.c
+++ b/refs.c
@@ -600,7 +600,8 @@ int dwim_log(const char *str, int len, struct object_id *oid, char **log)
 static int is_per_worktree_ref(const char *refname)
 {
 	return !strcmp(refname, "HEAD") ||
-		starts_with(refname, "refs/bisect/");
+		starts_with(refname, "refs/bisect/") ||
+		starts_with(refname, "refs/rewritten/");
 }
 
 static int is_pseudoref_syntax(const char *refname)
diff --git a/t/t3430-rebase-merges.sh b/t/t3430-rebase-merges.sh
index 5f0febb9970..96853784ec0 100755
--- a/t/t3430-rebase-merges.sh
+++ b/t/t3430-rebase-merges.sh
@@ -176,4 +176,18 @@ test_expect_success 'with a branch tip that was cherry-picked already' '
 	EOF
 '
 
+test_expect_success 'refs/rewritten/* is worktree-local' '
+	git worktree add wt &&
+	cat >wt/script-from-scratch <<-\EOF &&
+	label xyz
+	exec GIT_DIR=../.git git rev-parse --verify refs/rewritten/xyz >a || :
+	exec git rev-parse --verify refs/rewritten/xyz >b
+	EOF
+
+	test_config -C wt sequence.editor \""$PWD"/replace-editor.sh\" &&
+	git -C wt rebase -i HEAD &&
+	test_must_be_empty wt/a &&
+	test_cmp_rev HEAD "$(cat wt/b)"
+'
+
 test_done
-- 
2.17.0.windows.1.33.gfcbb1fa0445


