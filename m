Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-3.2 required=3.0 tests=AWL,BAYES_00,
	FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
	MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI shortcircuit=no autolearn=ham
	autolearn_force=no version=3.4.0
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id BC4AD1F424
	for <e@80x24.org>; Sat, 21 Apr 2018 10:44:28 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1752679AbeDUKo0 (ORCPT <rfc822;e@80x24.org>);
        Sat, 21 Apr 2018 06:44:26 -0400
Received: from mout.gmx.net ([212.227.17.22]:48541 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1751462AbeDUKoY (ORCPT <rfc822;git@vger.kernel.org>);
        Sat, 21 Apr 2018 06:44:24 -0400
Received: from [192.168.0.129] ([37.201.195.116]) by mail.gmx.com (mrgmx103
 [212.227.17.168]) with ESMTPSA (Nemesis) id 0LevUh-1edH1L0JUl-00qlFm; Sat, 21
 Apr 2018 12:44:16 +0200
Date:   Sat, 21 Apr 2018 12:43:59 +0200 (DST)
From:   Johannes Schindelin <johannes.schindelin@gmx.de>
X-X-Sender: virtualbox@MININT-6BKU6QN.europe.corp.microsoft.com
To:     git@vger.kernel.org
cc:     Junio C Hamano <gitster@pobox.com>,
        Jacob Keller <jacob.keller@gmail.com>,
        Stefan Beller <sbeller@google.com>,
        Philip Oakley <philipoakley@iee.org>,
        Eric Sunshine <sunshine@sunshineco.com>,
        Phillip Wood <phillip.wood@dunelm.org.uk>,
        Igor Djordjevic <igor.d.djordjevic@gmail.com>,
        Johannes Sixt <j6t@kdbg.org>,
        Sergey Organov <sorganov@gmail.com>,
        =?UTF-8?Q?Martin_=C3=85gren?= <martin.agren@gmail.com>
Subject: [PATCH v8 11/16] sequencer: make refs generated by the `label`
 command worktree-local
In-Reply-To: <cover.1524306546.git.johannes.schindelin@gmx.de>
Message-ID: <nycvar.QRO.7.76.6.1804211241320.4241@ZVAVAG-6OXH6DA.rhebcr.pbec.zvpebfbsg.pbz>
References: <cover.1524139900.git.johannes.schindelin@gmx.de> <cover.1524306546.git.johannes.schindelin@gmx.de>
User-Agent: Alpine 2.21.1 (DEB 209 2017-03-23)
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
X-Provags-ID: V03:K1:svG/RzniRh/Nn6v6nZopwgAFf3ARvlaeXfKYTcKrKOmqS9Qy62j
 kDRR+jmFeKvVTwjoCPyuLELyi5kE19USpwvKC89m1ha6q9Ol8Urn4A2M3sxDey6V4V5LfM8
 hvMLi34e60kH8fLCuW12z+fhHHHTK1mv6jtSHaOk8FjKXegR5JgtR4swTDdvO/eWyLylUC5
 wROWL5PBgC/gDwWHrBBow==
X-UI-Out-Filterresults: notjunk:1;V01:K0:XzCLTUz4q4g=:+IM6Empn3bTkY/2yPti9b+
 z4CM8O3CpA6271wz12TX1bG9JBG3RlxUme+P6QP9dDa7KBBZnSTMAlfvQ7FR+QHgyoesg0s/L
 XukLl1UJLgg+6gSHioG8ydLRqD+8uHC7rw1atQuuJoYTO+WJxbinlzY1jjDynFU1ZRG5BrmRw
 0+lAQQMQ9vgovUqA3WIBjBi55/OpHyplUMQK5gJeZpyAHZbSxHaFxGM1xg1GUspnK57531ffD
 RFVa14x1YgWklnFkIov9TIkPuoPiJJxt4OxdxqY3LUMrg0cvWE+ksMtnpsXOJMPbGkYnujwOL
 Vm5mY0aMKgBI0ZIK67vzxXtXHULWPPJoc6pur9UsCagJ8fT78G56if8FCxJuzwjg5/vPidFMb
 XW543Gi+jaG/e9MP4srF+RcxyhP+yk0fRKs8Vcu1zWes2tpG4qNMynO6bjcwHOOvKPi36q5VV
 0xKZQcYYHw8NCKJLcF1xa66kNVemmnbJHj+aVa3eG+4FTLbbJ+LaVhIkETvKo7tWvS9oiQZ+d
 CTRHAEY8lg2xuFiUTGvzVZoWkTYvfeG9IB2yqUjvCuN8L3zI4K3z3G0CE3KUDFM6EAzahkxm3
 hRIFlSfpxALoJHzF1wmlcd26d36BXZvsOPhHQEIUYe9B+2ADswkyrGNpbd7HCWCvUfNrMiNio
 GSJxPgTb7fw/lLaG2UfsiGSVR1rZn82Usdj61BJ7mDqh5d1CqYS7heZKJlMJEVgL5H97iJ9HZ
 S+3I8Dow4JqhknIVxjcfQQkSBSk6zdRupdsjybBDc8v8U5PWSXIQ6hZ9q4PATmkJ+UepkjewB
 O398f1sykp3RsIettDQhoT8i9PPM//uELTWgT/n2U5GkM4H4Cw=
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org

This allows for rebases to be run in parallel in separate worktrees
(think: interrupted in the middle of one rebase, being asked to perform
a different rebase, adding a separate worktree just for that job).

Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
---
 refs.c                   |  3 ++-
 t/t3430-rebase-merges.sh | 14 ++++++++++++++
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/refs.c b/refs.c
index 8b7a77fe5ee..f61ec58d1df 100644
--- a/refs.c
+++ b/refs.c
@@ -600,7 +600,8 @@ int dwim_log(const char *str, int len, struct object_id *oid, char **log)
 static int is_per_worktree_ref(const char *refname)
 {
 	return !strcmp(refname, "HEAD") ||
-		starts_with(refname, "refs/bisect/");
+		starts_with(refname, "refs/bisect/") ||
+		starts_with(refname, "refs/rewritten/");
 }
 
 static int is_pseudoref_syntax(const char *refname)
diff --git a/t/t3430-rebase-merges.sh b/t/t3430-rebase-merges.sh
index 5f0febb9970..96853784ec0 100755
--- a/t/t3430-rebase-merges.sh
+++ b/t/t3430-rebase-merges.sh
@@ -176,4 +176,18 @@ test_expect_success 'with a branch tip that was cherry-picked already' '
 	EOF
 '
 
+test_expect_success 'refs/rewritten/* is worktree-local' '
+	git worktree add wt &&
+	cat >wt/script-from-scratch <<-\EOF &&
+	label xyz
+	exec GIT_DIR=../.git git rev-parse --verify refs/rewritten/xyz >a || :
+	exec git rev-parse --verify refs/rewritten/xyz >b
+	EOF
+
+	test_config -C wt sequence.editor \""$PWD"/replace-editor.sh\" &&
+	git -C wt rebase -i HEAD &&
+	test_must_be_empty wt/a &&
+	test_cmp_rev HEAD "$(cat wt/b)"
+'
+
 test_done
-- 
2.17.0.windows.1.15.gaa56ade3205


