From: Junio C Hamano <junkio@cox.net>
Subject: Re: [PATCH 01/10] Add a birdview-on-the-source-code section to the user manual
Date: Tue, 15 May 2007 11:41:01 -0700
Message-ID: <7vlkfqj5fm.fsf@assigned-by-dhcp.cox.net>
References: <20070514181943.GA31749@diana.vm.bytemark.co.uk>
	<20070514183931.GC23090@fieldses.org>
	<20070515042200.GA10884@coredump.intra.peff.net>
	<20070515045044.GB2805@fieldses.org>
	<20070515050808.GA11745@coredump.intra.peff.net>
	<20070515082407.GA9096@diana.vm.bytemark.co.uk>
	<7v3b1ylb48.fsf@assigned-by-dhcp.cox.net>
	<20070515095756.GB18942@coredump.intra.peff.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Cc: Karl =?utf-8?Q?Hasselstr=C3=B6m?= <kha@treskal.com>,
	"J. Bruce Fields" <bfields@fieldses.org>, git@vger.kernel.org
To: Jeff King <peff@peff.net>
X-From: git-owner@vger.kernel.org Tue May 15 20:41:15 2007
Return-path: <git-owner@vger.kernel.org>
Envelope-to: gcvg-git@gmane.org
Received: from vger.kernel.org ([209.132.176.167])
	by lo.gmane.org with esmtp (Exim 4.50)
	id 1Ho1xP-00014M-8k
	for gcvg-git@gmane.org; Tue, 15 May 2007 20:41:11 +0200
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1755616AbXEOSlF (ORCPT <rfc822;gcvg-git@m.gmane.org>);
	Tue, 15 May 2007 14:41:05 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S1755790AbXEOSlF
	(ORCPT <rfc822;git-outgoing>); Tue, 15 May 2007 14:41:05 -0400
Received: from fed1rmmtao103.cox.net ([68.230.241.43]:63582 "EHLO
	fed1rmmtao103.cox.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1755616AbXEOSlE (ORCPT <rfc822;git@vger.kernel.org>);
	Tue, 15 May 2007 14:41:04 -0400
Received: from fed1rmimpo02.cox.net ([70.169.32.72])
          by fed1rmmtao103.cox.net
          (InterMail vM.7.05.02.00 201-2174-114-20060621) with ESMTP
          id <20070515184102.RJJI1318.fed1rmmtao103.cox.net@fed1rmimpo02.cox.net>;
          Tue, 15 May 2007 14:41:02 -0400
Received: from assigned-by-dhcp.cox.net ([68.5.247.80])
	by fed1rmimpo02.cox.net with bizsmtp
	id zWh11W00a1kojtg0000000; Tue, 15 May 2007 14:41:02 -0400
In-Reply-To: <20070515095756.GB18942@coredump.intra.peff.net> (Jeff King's
	message of "Tue, 15 May 2007 05:57:56 -0400")
User-Agent: Gnus/5.110006 (No Gnus v0.6) Emacs/21.4 (gnu/linux)
Sender: git-owner@vger.kernel.org
Precedence: bulk
X-Mailing-List: git@vger.kernel.org
Archived-At: <http://permalink.gmane.org/gmane.comp.version-control.git/47362>

Jeff King <peff@peff.net> writes:

> Unfortunately, I don't think we have the encoding information any more
> at that point. We can infer how the patch was generated by looking at
> the git-config, and that should be right 99% of the time (unless the
> patches were generated with a different config, either from another repo
> or before some settings were changed).
>
> Junio, can you confirm my understanding that:
>   - if i18n.logOutputEncoding is set, then we are definitely in that
>     encoding
>   - otherwise, if i18n.commitEncoding is set, we should assume commits are
>     in that encoding (which is just a guess, since they may have been
>     generated on another config, but it's our best guess)
>   - otherwise, assume utf-8

I do not want to break projects whose members consistently use a
single non UTF-8 encoding, and I've been hoping that in such a
use case they should not have to set any of these encoding
configuration.  So in that sense I would be somewhat reluctant
to agree with the last one.  But I am getting a feeling that it
is a losing battle.

On the patch acceptance side, when we do _not_ have encoding
information and the input does not look like a valid UTF-8, we
assume that the input is latin-1 and convert it to UTF-8, if I
recall correctly.  If somebody sent you a patch without encoding
header, and then you are forwarding that patch, not adding
anything ourselves (because we do not know) and let the
receiving end to do that conversion is certainly the best; but
if we _were_ to add anything I would suspect it would be a
better idea to use the same logic to default to latin-1 or
UTF-8.  East Asian users may want to raise objections here.

I think it is a reasonable compromise to do it the way you
outlined.  Doing it at patch generation time would fix the
ambiguity issues during the step 2, so it might turn out to be
necessary to add the encoding header to format-patch output
after all, but send-email needs to be able to handle messages
that do not have the header anyway, so probably the first step
is to do so in send-email.

When we update format-patch, the ambiguity at step 2 would
disappear.  My gut feeling is that adding an extra header to
format-patch output would not break people's workflow nor
scripts (I do not think it would break mine, as I either suck in
only the body of the message to my MUA or use send-email), but I
am not sure.

> Also Junio, it looks like commit 7cbcf4d5 moved parsing of the
> --encoding parameter into setup_revisions, but it's still being checked
> for in cmd_log_init. Can you confirm that the latter is now superfluous
> and can be removed?

Thanks for noticing, and I think you are right.  The code parses
the same input and sets the same global variable the same way.
