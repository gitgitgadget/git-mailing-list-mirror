Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-3.3 required=3.0 tests=AWL,BAYES_00,
	FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
	MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI shortcircuit=no autolearn=ham
	autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id AF26E1F453
	for <e@80x24.org>; Wed, 17 Oct 2018 14:58:24 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727047AbeJQWy1 (ORCPT <rfc822;e@80x24.org>);
        Wed, 17 Oct 2018 18:54:27 -0400
Received: from mout.gmx.net ([212.227.15.18]:51119 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726990AbeJQWy1 (ORCPT <rfc822;git@vger.kernel.org>);
        Wed, 17 Oct 2018 18:54:27 -0400
Received: from [192.168.0.129] ([37.201.193.149]) by mail.gmx.com (mrgmx001
 [212.227.17.190]) with ESMTPSA (Nemesis) id 0LmK3e-1fdBLH0Xvm-00ZwpF; Wed, 17
 Oct 2018 16:58:17 +0200
Received: from [192.168.0.129] ([37.201.193.149]) by mail.gmx.com (mrgmx001
 [212.227.17.190]) with ESMTPSA (Nemesis) id 0LmK3e-1fdBLH0Xvm-00ZwpF; Wed, 17
 Oct 2018 16:58:17 +0200
Date:   Wed, 17 Oct 2018 16:58:21 +0200 (DST)
From:   Johannes Schindelin <Johannes.Schindelin@gmx.de>
X-X-Sender: virtualbox@gitforwindows.org
To:     =?UTF-8?Q?SZEDER_G=C3=A1bor?= <szeder.dev@gmail.com>
cc:     Johannes Schindelin via GitGitGadget <gitgitgadget@gmail.com>,
        git@vger.kernel.org, Junio C Hamano <gitster@pobox.com>
Subject: Re: [PATCH v2 06/13] Add a build definition for Azure DevOps
In-Reply-To: <20181016191250.GO19800@szeder.dev>
Message-ID: <nycvar.QRO.7.76.6.1810171512100.4546@tvgsbejvaqbjf.bet>
References: <pull.31.git.gitgitgadget@gmail.com> <pull.31.v2.git.gitgitgadget@gmail.com> <1a22efe849d6da79f2c639c62a1483361a130238.1539598316.git.gitgitgadget@gmail.com> <20181016191250.GO19800@szeder.dev>
User-Agent: Alpine 2.21.1 (DEB 209 2017-03-23)
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="8323328-1992613047-1539788302=:4546"
X-Provags-ID: V03:K1:IezK4IVNrz6a6SntRZYQUGQCXApNl6wzRviiRm+28eYTP4KXz0D
 +OVwylkSYJGtX2rV1Auo0IJUyo3QX4+kEFBv5jDgh4LLyUjReTUr5rdbR1weIBhGHHmZMa/
 E9Df5nQlos5OM/1BGlBXQjLO+kTm1TPE/SiHAyN9BzViUlGpnxdbYgPz6D+oyRQj2yIMBrx
 iOhR8xp23/eVd60qLIE1g==
X-UI-Out-Filterresults: notjunk:1;V01:K0:r9C3Ta29/+I=:938M/qUU/a7A8rCB4BUkgh
 cBfxlz/3e4dedkVBo7UfxlMaC83eR9VDITixrQXkWuny1ZE8C5y1ygBdpv4JgzMrMAekVtkLC
 WMLy1/jvypKSvNAOY3rBPOu3LqZXuEDknp5J8/6FGxrCiGJZ94EW60BNW9Es8zXXVFu22/IGa
 Zdk2BL8dgvb+LxzzPBm8ZdmAdcQoOd03OMfQFTlp7FubTPMXFNHVPtXpNl0N4SNLHHVQWlq5G
 RmEs5ORF+t9XbUoxf5AcKSIAwgb1UDqx6IMAHcpvfTKwljgi0gmnp2PzKwrZnnmiiWPTzfsyc
 WkI5muVMOg2GXEeCdhiKHzYuwRkFXlXGZmmnUyXv3fsbmu525ZVBuSdk0YPpRX9PPXbRp9Pyf
 gktKZyDf+2W/7yuG3vfgUrkSLBlRleEsnQtca41JsO20gkuaqTZt90D8Uh6ygktjv/yHbkFBG
 sKv39t82SYxSJiOGRDi107DN7vB7l8SM0/YTTKiAN7UF+Lp2OSnLNGymchbI0FkfEiUi09ChE
 Yd0VWlgAzgObVvXpeUs0wRpNGKWwTOkjR4Ibx32+QC+uEQ/jHRjlrFcuk7HY1ir8vQceib7z2
 r9VDb3qBRkVChj6+Dnc3Q5IgLy+n2+xsz1HmYbGBnyA9xABn5Uz+4eQWz2VlBf4grfFmJjCl9
 KAMmR9gLaA/3sYkUDv8y3cOd5q1M7az5XXZ9Ox3yOop1/goQLIO17w70Wc3LeQ3JSbVyTakUy
 Z+ZZIHRSISw/TOtfce5taS0AGjvWLWI8gAbBoQgKduo4e0ayyKTlZH99AnP4nuFu74+LNPQQs
 bIc//1A2bYpNwzxAE17c8smKOx4TLcJFxeeVHigs7S0kN8gFms=
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.

--8323328-1992613047-1539788302=:4546
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8BIT

Hi Gábor,

On Tue, 16 Oct 2018, SZEDER Gábor wrote:

> On Mon, Oct 15, 2018 at 03:12:06AM -0700, Johannes Schindelin via GitGitGadget wrote:
> > diff --git a/azure-pipelines.yml b/azure-pipelines.yml
> > new file mode 100644
> > index 0000000000..b5749121d2
> > --- /dev/null
> > +++ b/azure-pipelines.yml
> > @@ -0,0 +1,319 @@
> > +resources:
> > +- repo: self
> > +  fetchDepth: 1
> > +
> > +phases:
> > +- phase: linux_clang
> > +  displayName: linux-clang
> > +  condition: succeeded()
> > +  queue:
> > +    name: Hosted Ubuntu 1604
> > +  steps:
> > +  - bash: |
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || ci/mount-fileshare.sh //gitfileshare.file.core.windows.net/test-cache gitfileshare "$GITFILESHAREPWD" "$HOME/test-cache" || exit 1
> > +
> > +       sudo apt-get update &&
> > +       sudo apt-get -y install git gcc make libssl-dev libcurl4-openssl-dev libexpat-dev tcl tk gettext git-email zlib1g-dev apache2-bin &&
> > +
> > +       export CC=clang || exit 1
> > +
> > +       ci/install-dependencies.sh
> 
> I think you would want to 'exit 1' when this script fails.
> This applies to other build jobs (erm, phases?) below as well.

True.

FWIW the nomenclature is "build" or "job" or "build job" for the entire
run, from what I understand. The "phase" is the individual chunk that is
run in an individual agent, i.e. you can have a single job running test on
different OSes in separate phases.

> > +       ci/run-build-and-tests.sh || {
> > +           ci/print-test-failures.sh
> > +           exit 1
> > +       }
> > +
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || sudo umount "$HOME/test-cache" || exit 1
> > +    displayName: 'ci/run-build-and-tests.sh'
> > +    env:
> > +      GITFILESHAREPWD: $(gitfileshare.pwd)
> > +  - task: PublishTestResults@2
> > +    displayName: 'Publish Test Results **/TEST-*.xml'
> > +    inputs:
> > +      mergeTestResults: true
> > +      testRunTitle: 'linux-clang'
> > +      platform: Linux
> > +      publishRunAttachments: false
> > +    condition: succeededOrFailed()
> > +
> > +- phase: linux_gcc
> > +  displayName: linux-gcc
> > +  condition: succeeded()
> > +  queue:
> > +    name: Hosted Ubuntu 1604
> > +  steps:
> > +  - bash: |
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || ci/mount-fileshare.sh //gitfileshare.file.core.windows.net/test-cache gitfileshare "$GITFILESHAREPWD" "$HOME/test-cache" || exit 1
> > +
> > +       sudo apt-get update &&
> > +       sudo apt-get -y install git gcc make libssl-dev libcurl4-openssl-dev libexpat-dev tcl tk gettext git-email zlib1g-dev apache2-bin || exit 1
> > +
> 
> On Travis CI the Linux GCC build job uses gcc-8 instead of whatever
> the default is in that old-ish Ubuntu LTS; see 37fa4b3c78 (travis-ci:
> run gcc-8 on linux-gcc jobs, 2018-05-19).

I'll add those dependencies explicitly. It does seem, however, from a
cursory look at the log, that gcc-8 should not even be picked up, as it is
set via the environment variable `CC` (which, as you point out in
below-referenced thread, is not respected):

[...]
2018-10-16T10:00:36.0177072Z ++ '[' linux-gcc = linux-gcc ']'
2018-10-16T10:00:36.0177380Z ++ export CC=gcc-8
2018-10-16T10:00:36.0177630Z ++ CC=gcc-8
2018-10-16T10:00:36.0177917Z ++ case "$jobname"
[...]

(see https://dev.azure.com/git/git/_build/results?buildId=192&view=logs)

> > +       ci/install-dependencies.sh
> > +       ci/run-build-and-tests.sh || {
> > +           ci/print-test-failures.sh
> > +           exit 1
> > +       }
> > +
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || sudo umount "$HOME/test-cache" || exit 1
> > +    displayName: 'ci/run-build-and-tests.sh'
> > +    env:
> > +      GITFILESHAREPWD: $(gitfileshare.pwd)
> > +  - task: PublishTestResults@2
> > +    displayName: 'Publish Test Results **/TEST-*.xml'
> > +    inputs:
> > +      mergeTestResults: true
> > +      testRunTitle: 'linux-gcc'
> > +      platform: Linux
> > +      publishRunAttachments: false
> > +    condition: succeededOrFailed()
> > +
> > +- phase: osx_clang
> > +  displayName: osx-clang
> > +  condition: succeeded()
> > +  queue:
> > +    name: Hosted macOS
> > +  steps:
> > +  - bash: |
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || ci/mount-fileshare.sh //gitfileshare.file.core.windows.net/test-cache gitfileshare "$GITFILESHAREPWD" "$HOME/test-cache" || exit 1
> > +
> > +       export CC=clang
> > +
> > +       ci/install-dependencies.sh
> > +       ci/run-build-and-tests.sh || {
> > +           ci/print-test-failures.sh
> > +           exit 1
> > +       }
> > +
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || umount "$HOME/test-cache" || exit 1
> > +    displayName: 'ci/run-build-and-tests.sh'
> > +    env:
> > +      GITFILESHAREPWD: $(gitfileshare.pwd)
> > +  - task: PublishTestResults@2
> > +    displayName: 'Publish Test Results **/TEST-*.xml'
> > +    inputs:
> > +      mergeTestResults: true
> > +      testRunTitle: 'osx-clang'
> > +      platform: macOS
> > +      publishRunAttachments: false
> > +    condition: succeededOrFailed()
> > +
> > +- phase: osx_gcc
> > +  displayName: osx-gcc
> > +  condition: succeeded()
> > +  queue:
> > +    name: Hosted macOS
> > +  steps:
> > +  - bash: |
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || ci/mount-fileshare.sh //gitfileshare.file.core.windows.net/test-cache gitfileshare "$GITFILESHAREPWD" "$HOME/test-cache" || exit 1
> > +
> 
> Here you should 'export CC=gcc', because on macOS 'cc' is 'clang' by
> default.
> 
> Note, however, that setting 'CC' in the environment alone has no
> effect on the build process, it will still use 'cc'.  Keep an eye on
> where this thread will lead to:
> 
>   https://public-inbox.org/git/20181016184537.GN19800@szeder.dev/T/#u

Will do.

Thanks,
Dscho

> 
> > +       ci/install-dependencies.sh
> > +       ci/run-build-and-tests.sh || {
> > +           ci/print-test-failures.sh
> > +           exit 1
> > +       }
> > +
> > +       test "$GITFILESHAREPWD" = '$(gitfileshare.pwd)' || umount "$HOME/test-cache" || exit 1
> > +    displayName: 'ci/run-build-and-tests.sh'
> > +    env:
> > +      GITFILESHAREPWD: $(gitfileshare.pwd)
> > +  - task: PublishTestResults@2
> > +    displayName: 'Publish Test Results **/TEST-*.xml'
> > +    inputs:
> > +      mergeTestResults: true
> > +      testRunTitle: 'osx-gcc'
> > +      platform: macOS
> > +      publishRunAttachments: false
> > +    condition: succeededOrFailed()
> > +
> 
--8323328-1992613047-1539788302=:4546--
