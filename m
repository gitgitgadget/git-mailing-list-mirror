Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-3.3 required=3.0 tests=AWL,BAYES_00,
	FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
	MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI shortcircuit=no autolearn=ham
	autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 2D7261F453
	for <e@80x24.org>; Mon, 22 Oct 2018 20:52:56 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1729376AbeJWFNA (ORCPT <rfc822;e@80x24.org>);
        Tue, 23 Oct 2018 01:13:00 -0400
Received: from mout.gmx.net ([212.227.15.19]:46615 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1729060AbeJWFNA (ORCPT <rfc822;git@vger.kernel.org>);
        Tue, 23 Oct 2018 01:13:00 -0400
Received: from [192.168.0.129] ([37.201.193.149]) by mail.gmx.com (mrgmx002
 [212.227.17.190]) with ESMTPSA (Nemesis) id 0M08ia-1fKnip37S0-00uGYq; Mon, 22
 Oct 2018 22:52:51 +0200
Received: from [192.168.0.129] ([37.201.193.149]) by mail.gmx.com (mrgmx002
 [212.227.17.190]) with ESMTPSA (Nemesis) id 0M08ia-1fKnip37S0-00uGYq; Mon, 22
 Oct 2018 22:52:51 +0200
Date:   Mon, 22 Oct 2018 22:52:54 +0200 (DST)
From:   Johannes Schindelin <Johannes.Schindelin@gmx.de>
X-X-Sender: virtualbox@gitforwindows.org
To:     =?UTF-8?Q?Nguy=E1=BB=85n_Th=C3=A1i_Ng=E1=BB=8Dc_Duy?= 
        <pclouds@gmail.com>
cc:     git@vger.kernel.org,
        =?UTF-8?Q?=C3=86var_Arnfj=C3=B6r=C3=B0?= <avarab@gmail.com>
Subject: Re: [PATCH] Poison gettext with the Ook language
In-Reply-To: <20181022153633.31757-1-pclouds@gmail.com>
Message-ID: <nycvar.QRO.7.76.6.1810222252250.4546@tvgsbejvaqbjf.bet>
References: <20181022153633.31757-1-pclouds@gmail.com>
User-Agent: Alpine 2.21.1 (DEB 209 2017-03-23)
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="8323328-936446519-1540241575=:4546"
X-Provags-ID: V03:K1:ZA+BT0PMKQUn13RPsrMSxYusQ9X5eJTKBDcbShItRGqH6GoafZF
 aKys9AWaRIDenVIq6Q8wxGGyoD2NBMQcFikZXaWxhkntjFg7MhgCBI3anRmKyki2a7+RPg4
 tphB/yflRdC5kOuFpWZ1drPkmH7zaYKUisHb+AznnaeKJx8nFZDWRqBy93IUz19OEZzQVSg
 LBS9n7VkIJrjpMBlDuhaA==
X-UI-Out-Filterresults: notjunk:1;V01:K0:ALiI9mgbPlo=:DVpgD/tLmPDPGukKdv9G5Q
 vp5chIEFasp7mUVxuIEcbipWTSQgLcILG8IVgLrK4za2awEJCRVAuEmVBaZm1zxHWEioMNmkq
 NzKdNn0+srRL3HvUk2f5THLcn9j9UuvfixwWHQpbk8ANyWH9ikZhGZiEKLrl4PPvzMDzyoEXH
 z3e1uu4LVb3azxvZFiAf8IKTkTfmiONQWZqMO48RbWM5XOIFH0CwBpItXlnweegpru3m4itQz
 aMegtuSpklMR6EaZcAr5OyAbEVD2kgM7B9aFaNaRd+cD7XQCGlpbdl7YYa+SR3itdtfcFVATI
 RWcyNdSd55Mn/yK5I9FYj14m+L8cHFmcMbLTQzOiYcr8Ss7eIst0GdVThHiTFcGOo5Lep/mNR
 2jpOBqyyJlS9MWsZLDJEch2typUvlI9o0Bw5yMDTKgm0BMpdI+4WuHGfyITpBnqgeGiukkH0d
 dgXHTjC5gExFHFiCzQEiYkqxQGHl2e4QWkW9IwpqDHhFBFOgvZc7R1Q2ezIj/Q67s47vG9hjQ
 flQXJXQAwKAKf4jP/q+9u3BN/G/bQNLFM0Q3BUUI7Z6jAEjQfpZhoPAhzOR3GI8EZHspJGY6a
 SewQrwzhHAtrdAm2vKEzlYAoo9bqsskV80C6XA+9qAok9rwwEvcwx9+ZfU/ptIsdQfZJZgA55
 BNBUBFL1Jym6r8UosrbdIdftRODMszk7iIhIg67fY1oZRvxQYrBdYW44wcWcWC/Zy1SWhGTZU
 fIgdH90C4UKayIRmEOraBxlaOt4TBvh2UWZGDIUyEnjV/HAMti9QUCyLa+3gPBrICuAsUNVL8
 mRpuhVe0YsF6PXwbQeToEimsnNggi1Yk+S7dh3ywD6eJl/jCkM=
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.

--8323328-936446519-1540241575=:4546
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8BIT

Hi Duy,

On Mon, 22 Oct 2018, Nguyễn Thái Ngọc Duy wrote:

> The current gettext() function just replaces all strings with
> '# GETTEXT POISON #' including format strings and hides the things
> that we should be allowed to grep (like branch names, or some other
> codes) even when gettext is poisoned.
> 
> This patch implements the poisoned _() with a universal and totally
> legit language called Ook [1]. We could actually grep stuff even in
> with this because format strings are preserved.
> 
> Long term, we could implement an "ook translator" for test_i18ngrep
> and friends so that they translate English to Ook, allowing us to
> match full text while making sure the text in the code is still marked
> for translation.
> 
> [1] https://en.wikipedia.org/wiki/Unseen_University#Librarian
> 
> Signed-off-by: Nguyễn Thái Ngọc Duy <pclouds@gmail.com>
> ---
>  This started out as something fun to do while running the test suite
>  last weekend. But it turns out actually working! If this patch ends
>  up in git.git, the Librarian would be so proud!

Cute.
Dscho

> 
>  gettext.c       | 54 +++++++++++++++++++++++++++++++++++++++++++++++++
>  gettext.h       |  7 ++++---
>  t/lib-rebase.sh |  2 +-
>  3 files changed, 59 insertions(+), 4 deletions(-)
> 
> diff --git a/gettext.c b/gettext.c
> index 7272771c8e..29901e1ddd 100644
> --- a/gettext.c
> +++ b/gettext.c
> @@ -56,6 +56,60 @@ int use_gettext_poison(void)
>  }
>  #endif
>  
> +const char *gettext_poison(const char *msgid)
> +{
> +	/*
> +	 * gettext() returns a string that is always valid. We would
> +	 * need a hash map for that but let's stay simple and keep the
> +	 * last 64 gettext() results. Should be more than enough.
> +	 */
> +	static char *bufs[64];
> +	static int i;
> +	struct strbuf sb = STRBUF_INIT;
> +	char *buf;
> +	const char *p;
> +	const char *type_specifiers = "diouxXeEfFgGaAcsCSpnm%";
> +
> +	if (!strchr(msgid, '%'))
> +		return "Eek!";
> +
> +	p = msgid;
> +	while (*p) {
> +		const char *type;
> +		switch (*p) {
> +		case '%':
> +			/*
> +			 * No strict parsing. We simply look for the end of a
> +			 * format string
> +			 */
> +			type = p + 1;
> +			while (*type && !strchr(type_specifiers, *type))
> +				type++;
> +			if (*type)
> +				type++;
> +			strbuf_add(&sb, p, (int)(type - p));
> +			p = type;
> +			break;
> +		default:
> +			if (!isalpha(*p)) {
> +				strbuf_addch(&sb, *p);
> +				p++;
> +				break;
> +			}
> +			if (isupper(*p))
> +				strbuf_addstr(&sb, "Ook");
> +			else
> +				strbuf_addstr(&sb, "ook");
> +			while (isalpha(*p))
> +				p++;
> +		}
> +	}
> +	buf = bufs[(i++) % ARRAY_SIZE(bufs)];
> +	free(buf);
> +	buf = strbuf_detach(&sb, NULL);
> +	return buf;
> +}
> +
>  #ifndef NO_GETTEXT
>  static int test_vsnprintf(const char *fmt, ...)
>  {
> diff --git a/gettext.h b/gettext.h
> index 7eee64a34f..dc9851a06a 100644
> --- a/gettext.h
> +++ b/gettext.h
> @@ -41,8 +41,9 @@ static inline int gettext_width(const char *s)
>  }
>  #endif
>  
> +const char *gettext_poison(const char *);
>  #ifdef GETTEXT_POISON
> -extern int use_gettext_poison(void);
> +int use_gettext_poison(void);
>  #else
>  #define use_gettext_poison() 0
>  #endif
> @@ -51,14 +52,14 @@ static inline FORMAT_PRESERVING(1) const char *_(const char *msgid)
>  {
>  	if (!*msgid)
>  		return "";
> -	return use_gettext_poison() ? "# GETTEXT POISON #" : gettext(msgid);
> +	return use_gettext_poison() ? gettext_poison(msgid) : gettext(msgid);
>  }
>  
>  static inline FORMAT_PRESERVING(1) FORMAT_PRESERVING(2)
>  const char *Q_(const char *msgid, const char *plu, unsigned long n)
>  {
>  	if (use_gettext_poison())
> -		return "# GETTEXT POISON #";
> +		return gettext_poison(msgid);
>  	return ngettext(msgid, plu, n);
>  }
>  
> diff --git a/t/lib-rebase.sh b/t/lib-rebase.sh
> index 2ca9fb69d6..1e8440e935 100644
> --- a/t/lib-rebase.sh
> +++ b/t/lib-rebase.sh
> @@ -29,7 +29,7 @@ set_fake_editor () {
>  	*/COMMIT_EDITMSG)
>  		test -z "$EXPECT_HEADER_COUNT" ||
>  			test "$EXPECT_HEADER_COUNT" = "$(sed -n '1s/^# This is a combination of \(.*\) commits\./\1/p' < "$1")" ||
> -			test "# # GETTEXT POISON #" = "$(sed -n '1p' < "$1")" ||
> +			test "$EXPECT_HEADER_COUNT" = "$(sed -n '1s/^# Ook ook ook ook ook \(.*\) ook\./\1/p' < "$1")" ||
>  			exit
>  		test -z "$FAKE_COMMIT_MESSAGE" || echo "$FAKE_COMMIT_MESSAGE" > "$1"
>  		test -z "$FAKE_COMMIT_AMEND" || echo "$FAKE_COMMIT_AMEND" >> "$1"
> -- 
> 2.19.1.647.g708186aaf9
> 
> 
--8323328-936446519-1540241575=:4546--
