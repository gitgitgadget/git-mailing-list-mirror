From: Samium Gromoff <_deepfire@feelingofgreen.ru>
Subject: Git-tag's over-aggressive pipework fails badly on fresh Ubuntu, over NFS.
Date: Wed, 26 Sep 2007 02:34:25 +0400
Message-ID: <87hclifk7i.wl@betelheise.deep.net>
Mime-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
To: git@vger.kernel.org
X-From: git-owner@vger.kernel.org Wed Sep 26 00:43:39 2007
Return-path: <git-owner@vger.kernel.org>
Envelope-to: gcvg-git-2@gmane.org
Received: from vger.kernel.org ([209.132.176.167])
	by lo.gmane.org with esmtp (Exim 4.50)
	id 1IaJ7w-00023P-LC
	for gcvg-git-2@gmane.org; Wed, 26 Sep 2007 00:43:37 +0200
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1752133AbXIYWnP (ORCPT <rfc822;gcvg-git-2@m.gmane.org>);
	Tue, 25 Sep 2007 18:43:15 -0400
Received: (majordomo@vger.kernel.org) by vger.kernel.org id S1751835AbXIYWnO
	(ORCPT <rfc822;git-outgoing>); Tue, 25 Sep 2007 18:43:14 -0400
Received: from 69-100-st.zelcom.ru ([80.92.100.69]:44880 "EHLO
	etherstorm.feelingofgreen.ru" rhost-flags-OK-FAIL-OK-FAIL)
	by vger.kernel.org with ESMTP id S1751303AbXIYWnN (ORCPT
	<rfc822;git@vger.kernel.org>); Tue, 25 Sep 2007 18:43:13 -0400
X-Greylist: delayed 521 seconds by postgrey-1.27 at vger.kernel.org; Tue, 25 Sep 2007 18:43:13 EDT
Received: from betelheise.deep.net (betelheise.deep.net [10.128.0.1])
	by etherstorm.feelingofgreen.ru (Postfix) with ESMTP id 2BC153B359
	for <git@vger.kernel.org>; Tue, 25 Sep 2007 22:21:51 +0400 (MSD)
User-Agent: Wanderlust/2.15.5 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.8 (=?ISO-8859-4?Q?Shij=F2?=) APEL/10.6 Emacs/23.0.51
 (i686-pc-linux-gnu) MULE/5.0 (SAKAKI)
X-Face: "P-:w!.&Hdk.h~~pT`!Q%H6;/8Cce^m&%vIn"W-SXb4h88dCgwD\_}N5:\}lowY2gxg0u^wVO*L\$C@MvBDRTmh/=,468w{W{OTc$kfq5O9Y!`pd+N}SMHrN+Gs>jXe5}}EL`cRbc0^_0cZ-}M\b~55I;Qe$1uL8M`M`82<_%CQ(GwLk."M>zBLn:-u>n,$kjH`~Uo[pH`08#\G!GVMd`%7![m9]*w5PMts4@m>=;lX41Z90N
Sender: git-owner@vger.kernel.org
Precedence: bulk
X-Mailing-List: git@vger.kernel.org
Archived-At: <http://permalink.gmane.org/gmane.comp.version-control.git/59185>

Hello folks,

Without the following applied, git-tag -s gets zeroes into TAG_TMP
in place of the .asc sig, resulting in an unsigned commit.

My repository is located on a NFS share, and I didn't check with NFS factored
out, so it might be more extensive.

I'm not sure what's the policy -- "go and fix Ubuntu, your filesystem
and your kernel", or "let's go the safe way", so there it is.

--- a/git-tag   2007-09-07 22:12:11.000000000 +0400
+++ b/git-tag   2007-09-26 02:19:42.000000000 +0400
@@ -143,7 +143,8 @@
     rm -f "$GIT_DIR"/TAG_TMP.asc "$GIT_DIR"/TAG_FINALMSG
     if [ "$signed" ]; then
        gpg -bsa -u "$username" "$GIT_DIR"/TAG_TMP &&
-       cat "$GIT_DIR"/TAG_TMP.asc >>"$GIT_DIR"/TAG_TMP ||
+       cat "$GIT_DIR"/TAG_TMP "$GIT_DIR"/TAG_TMP.asc > "$GIT_DIR"/TAG_TMP_RELAY &&
+       mv "$GIT_DIR"/TAG_TMP_RELAY "$GIT_DIR"/TAG_TMP ||
        die "failed to sign the tag with GPG."
     fi
     object=$(git-mktag < "$GIT_DIR"/TAG_TMP)

Git is 1.5.2.5-2build1/Gutsy.

regards, Samium Gromoff
