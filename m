Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.1 (2015-04-28) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-3.5 required=3.0 tests=AWL,BAYES_00,
	FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
	MAILING_LIST_MULTI,RCVD_IN_DNSWL_HI shortcircuit=no autolearn=ham
	autolearn_force=no version=3.4.1
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 6C5681F453
	for <e@80x24.org>; Fri,  9 Nov 2018 13:06:26 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727784AbeKIWq5 (ORCPT <rfc822;e@80x24.org>);
        Fri, 9 Nov 2018 17:46:57 -0500
Received: from mout.gmx.net ([212.227.17.21]:55469 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1727662AbeKIWq5 (ORCPT <rfc822;git@vger.kernel.org>);
        Fri, 9 Nov 2018 17:46:57 -0500
Received: from [192.168.0.129] ([37.201.193.149]) by mail.gmx.com (mrgmx102
 [212.227.17.168]) with ESMTPSA (Nemesis) id 0LfHs4-1fjd5R13mK-00opPM; Fri, 09
 Nov 2018 14:06:21 +0100
Date:   Fri, 9 Nov 2018 14:06:20 +0100 (STD)
From:   Johannes Schindelin <Johannes.Schindelin@gmx.de>
X-X-Sender: virtualbox@gitforwindows.org
To:     =?UTF-8?Q?=C3=86var_Arnfj=C3=B6r=C3=B0_Bjarmason?= 
        <avarab@gmail.com>
cc:     Taylor Blau <me@ttaylorr.com>, Stefan Xenos <sxenos@google.com>,
        git@vger.kernel.org
Subject: Re: Git Evolve
In-Reply-To: <877ej0iuhc.fsf@evledraar.gmail.com>
Message-ID: <nycvar.QRO.7.76.6.1811091357190.39@tvgsbejvaqbjf.bet>
References: <CAPL8ZivFmHqS2y+WmNR6faRMnuahiqwPVYsV99NiJ1QLHOs9fQ@mail.gmail.com> <20181002012326.GA96979@syl> <877ej0iuhc.fsf@evledraar.gmail.com>
User-Agent: Alpine 2.21.1 (DEB 209 2017-03-23)
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="8323328-1253545593-1541768781=:39"
X-Provags-ID: V03:K1:FdbxxUz5ylHLooIU/UapZ/lcv56MbaCFLt8SNAt/syiblH7sRSx
 3kHqhesiFUqnm3WTxU1P3kdSglcBjWGNkADMTK39Bw/mc3nx5y4Dst7snvb6fwqUZCTC2k8
 UtYrWZ4cZCbNBkqyZUfav/EQB6LF9WE2FROOP4fcjer/L/4sKXG3GUSJZDmRiOO8LKFYvgX
 C/c1Jop+J6/7cgAt99+IQ==
X-UI-Out-Filterresults: notjunk:1;V01:K0:21jFwy+blQs=:WiBQF/ZbClJXK00ZIDVhvx
 RNhHjBYlIUGNxEVil9y3idJy39ywI2C+pZ2FbPghitsjTjVesgASpv6Tg8ndfci2n7VyH4Xrl
 mWtUox/6PnqHCkuoSQAJcTIo8JBYwwqVXxKiEnEfA/zK6cv7ZeB8N2Vj956SZ9BMUZD/3+nZg
 qbJ2f04ZysSbmgexgffxzTot4iziDb+DkjllObZxlYVN+jyYSEau3pUyOGj59K+Rh1qjNtktX
 NeYdongeEbtwHvPW3MrenLkyXZ97TB6W+xXn3MPrHROZ7Tk8eidq4XkVYN7dXLJJLpOYxUm9m
 gRiZEXpZOAPJT2GXR5Zx6yD3VvI6HZ66stvHoNtrCvl8c4864/4LaUDTYoiV+J78HM/kHhybL
 7DqB1RS0wwUhwp+Srt+qpd7bDAGWY9Sv9e5dqGrt0R0ecg7A6Yx94huPMWcgN/XDnTZrN3mFl
 xTN5ISb9mkOv3q2OsbLc/55F7jOIBx/41RbTolw7uXih/Wb6ykmWVCgVdetoGl1daoFdanVKl
 gacCh8AzO3oIf6isKw683E4A9bSLAnTo/4HCSPsGGtCAnNgh7o0o6efuVlOCsRV0siJdOdI5Q
 jm2Xs08KrRgpSS8uoNJD4QRSB5AJFbkU6Axd/ZadrYHvy1AqSh8O3ZYiYFL4MM5YKtdsdFidn
 s2w/lvT13N8jOS3BR6cqNfg3v0irqkpMlTF6Xw95JQ4vsurqkEaB8occjSf3BHJI24GlDLzuf
 4ZeQj7HGS03KVN650jOahVPwm88ZHQcC3Z8u76Ajr827SCTh2ihwg/vjD355CGMOqKvVKN/mO
 QbEar18lYQTctRzNP5/Q0l1cFZs/zbmO4Hrc5YPDkd/BTkVKBigHvFSiw0XI8xb6I4xDx3rcR
 V0nXqsPsw3R70aHWv9dq23uZNDU0rjYNjkGHI1ZnZE1wZm+9Ks8ue+5QH6C7FUfgpco3pqb+I
 x6vJS4yoj7g==
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.

--8323328-1253545593-1541768781=:39
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8BIT

Hi,

On Tue, 2 Oct 2018, Ævar Arnfjörð Bjarmason wrote:

> On Tue, Oct 02 2018, Taylor Blau wrote:
> 
> > Hi Stefan,
> >
> > On Sat, Sep 29, 2018 at 04:00:04PM -0700, Stefan Xenos wrote:
> >> Hello, List!
> >>
> >> I'm interested in porting something like Mercurial's evolve command to
> >> Git.
> >
> > Welcome to Git :-). I think that the discussion in this thread is good,
> > but it's not why I'm replying. I have also wanted a Mercurial feature in
> > Git, but a different one than yours.
> >
> > Specifically, I've wanted the 'hg absorb' command. My understanding of
> > the commands functionality is that it builds a sort of flamegraph-esque
> > view of the blame, and then cascades downwards parts of a change. I am
> > sure that I'm not doing the command justice, so I'll defer to [1] where
> > it is explained in more detail.
> >
> > The benefit of this command is that it gives you a way to--without
> > ambiguity--absorb changes into earlier commits, and in fact, the
> > earliest commit that they make sense to belong to.
> >
> > This would simplify my workflow greatly when re-rolling patches, as I
> > often want to rewrite a part of an earlier commit. This is certainly
> > possible by a number of different `git rebase` invocations (e.g., (1)
> > create fixup commits, and then re-order them, or (2) mark points in your
> > history as 'edit', and rewrite them in a detached state, and I'm sure
> > many more).
> >
> > I'm curious if you or anyone else has thought about how this might work
> > in Git.
> 
> I've wanted a "git absorb" for a while, but have done no actual work on
> it, I just found out about it.
> 
> I think a combination of these two heuristics would probably do the
> trick:
> 
>  1. If a change in your "git diff" output has a hunk whose lines overlap
>     with an earlier commit in the @{u}.. range, we do the equivalent of
>     "git add -p", select that hunk, and "git commit --fixup <that
>     commit>". We fixup the most recent commit that matches (otherwise
>     commit>we'd conflict).
> 
>  2. Have some mode where we fall back from #1 and consider changes to
>     entire files, if that's unambiguous.
> 
> The neat thing about this would be that you could tweak how promiscuous
> #1 would be via the -U option to git-diff, and #2 would just be a
> special case of -U9999999999999 (we should really add a -Uinf...).
> 
> Then once you ran this you could run "git rebase -i --autosquash" to see
> how the TODO list would look, and optionally have some "git absorb
> --now" or whatever to do the "git add -p", "git commit --fixup" and "git
> rebase --autosquash" all in one go.

This is essentially what the script does that I sent to this here mailing
list back in May:
https://public-inbox.org/git/nycvar.QRO.7.76.6.1805052220360.77@tvgsbejvaqbjf.bet/

I used this quite a lot, but I still find it slow (especially on Windows),
so I am still in search for a better solution. And yes, I was intrigued by
`hg absorb` when it was presented at GitMerge last year, and wanted to
have the same.

In the meantime, what I often do is to call `git log -L <range>:<file>`
where <range> and <file> are taken from the hunk(s) of the current diff.
Actually, I have a script to do that, hidden behind a Git alias. Then I
inspect the diffs in that log and call `git commit --fixup` with the one I
deem most appropriate.

Note that it sometimes fails because of semantic dependencies. That is,
even if my current change overlaps with an earlier change, it may be too
early to be squashed in.

As an example: imagine that I moved a git_config() call from some function
into the cmd_<command>() function. Only: I intended to move it, but in
fact, I just added the call to the latter function. Eventually, I figure
it out! So I want to make a fixup! commit. My script, as well as Ævar's
suggestion, as well as literally all the other attempts to solve this that
I am aware of, would try to squash this change into whichever commit
introduced the function that originally called git_config(). But that is
wrong. It should be squashed into the commit that added the git_config()
call to the cmd_<command>() function.

Ciao,
Dscho

> 
> > [1]: http://files.lihdd.net/hgabsorb-note.pdf
> 
--8323328-1253545593-1541768781=:39--
