Return-Path: <git-owner@vger.kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on dcvr.yhbt.net
X-Spam-Level: 
X-Spam-ASN: AS31976 209.132.180.0/23
X-Spam-Status: No, score=-2.6 required=3.0 tests=AWL,BAYES_00,
	FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
	RCVD_IN_DNSWL_HI,T_RP_MATCHES_RCVD shortcircuit=no autolearn=no
	autolearn_force=no version=3.4.0
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by dcvr.yhbt.net (Postfix) with ESMTP id 0B8DF1FAE2
	for <e@80x24.org>; Mon, 29 Jan 2018 22:55:13 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1751988AbeA2WzJ (ORCPT <rfc822;e@80x24.org>);
        Mon, 29 Jan 2018 17:55:09 -0500
Received: from mout.gmx.net ([212.227.15.19]:51830 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1751970AbeA2WzH (ORCPT <rfc822;git@vger.kernel.org>);
        Mon, 29 Jan 2018 17:55:07 -0500
Received: from MININT-KR8J64V.europe.corp.microsoft.com ([37.201.193.1]) by
 mail.gmx.com (mrgmx001 [212.227.17.190]) with ESMTPSA (Nemesis) id
 0MZkv0-1eKutO1HCg-00LTcl; Mon, 29 Jan 2018 23:55:00 +0100
Date:   Mon, 29 Jan 2018 23:54:59 +0100 (STD)
From:   Johannes Schindelin <johannes.schindelin@gmx.de>
X-X-Sender: virtualbox@MININT-6BKU6QN.europe.corp.microsoft.com
To:     git@vger.kernel.org
cc:     Junio C Hamano <gitster@pobox.com>,
        Jacob Keller <jacob.keller@gmail.com>,
        Stefan Beller <sbeller@google.com>,
        Philip Oakley <philipoakley@iee.org>,
        Eric Sunshine <sunshine@sunshineco.com>,
        Phillip Wood <phillip.wood@dunelm.org.uk>
Subject: [PATCH v2 07/10] sequencer: make refs generated by the `label`
 command worktree-local
In-Reply-To: <cover.1517266437.git.johannes.schindelin@gmx.de>
Message-ID: <de018eb9e0799cfe3a1b8c7fb364de41cb161229.1517266437.git.johannes.schindelin@gmx.de>
References: <cover.1516225925.git.johannes.schindelin@gmx.de> <cover.1517266437.git.johannes.schindelin@gmx.de>
User-Agent: Alpine 2.21.1 (DEB 209 2017-03-23)
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
X-Provags-ID: V03:K0:X4L3ZR/+Mf4D1Z8G2jTyjp8x0J5VxJ7b5tUmqaYWPdo0u3pHn/M
 NfR8Zwk9k7WsdCy8D6CQ81WVxcvVPV+y9kFqRoAgrAjkL5k+6dD6t0p806FKshAZxXe0sg0
 wuZx1lyNHg79Z3c3WlMYOusoHhqs9YFW2MUYibJWuGaa4x0S+EFzKoD0K0VC6rfb7NAOcAC
 AG5d3F1E2YROVudpr+ABg==
X-UI-Out-Filterresults: notjunk:1;V01:K0:olFqL3OeCco=:FoyQnBmafFv00fpo/ElLe+
 7S1RY+HOUUdG216u1Oi1JsfM5YF6cxBxaqvd4mzRRnCJnBUkj2hI5KK6xwkDFGKPmYoKWaY7U
 SRtNqP8CimqS3sGiHyVP5y72JpKq3FZALwqjJGXSASnsvz4LQl2Uuk2lZQl0PhMxTp1h2lQYk
 Tckar5Omcv3uUSGjaPjvI0BG7mNq0iP2MISiopdvDraNkPD7KFg2PGNbAE3sOAepF+3YBxo1M
 cYGJ/SmKQDRtPUuzJy6VQjIN//vDufQJS1UvmYhuWfuFHPcm5TM+6vt0c0OWjDpDFu8gcSwge
 ceQJ8fp7PtwHrjLG7F5IaNiGDFy15Q7LAY0Q458eSgQ80nyyJ1guk2tquP/Ezdyhc+uQG8shl
 8kFOBAybBCFYf2oPgM3W/teOvlPbAdotb8Kl/Roep86QphJAgFivd5/T42M9Q9HR8rXIhiEnE
 38U1wR1+SUb7je5n4bl+4KXq+c8ZRltQ2pW12+tn0kccxWRrT+5G9jE1h8E+zUUwjJ4H5sI5e
 wCv6s0JKEdOd3obHuOCp76MBfT0mm2EuMlrckkkuWGA5w5EdhpRmqxAJIpIkG/XOHUOqc/mK+
 eaDrE2Et1g7A4uEKUBiFYBcZZs+/dJ6+jX/iLsCj4fn0gxJPSY6rnMYfeFnQHln7tgoOaySDi
 QbBK0c0AZBW4epCMA3QB6Uiaxc4uqKQAf14BlEUiCLvK/E0HlnA+Az+QKq4wQuA+JH20vUohV
 iko51K4yrHtrO92ZbMchiO2xA7xmjUHnvIDSDWulT81twn+3AaZc8XRK8GwNJQRnq11Pm0TB4
 r7YI52fJlb4ipsRuKfsBkNSsdDJFJf1GO7OkX0NLTltWMNTcH+OMLcGq/xn+gXx3CFqC2CF
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org

This allows for rebases to be run in parallel in separate worktrees
(think: interrupted in the middle of one rebase, being asked to perform
a different rebase, adding a separate worktree just for that job).

Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
---
 refs.c                            |  3 ++-
 t/t3430-rebase-recreate-merges.sh | 14 ++++++++++++++
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/refs.c b/refs.c
index 20ba82b4343..e8b84c189ff 100644
--- a/refs.c
+++ b/refs.c
@@ -600,7 +600,8 @@ int dwim_log(const char *str, int len, struct object_id *oid, char **log)
 static int is_per_worktree_ref(const char *refname)
 {
 	return !strcmp(refname, "HEAD") ||
-		starts_with(refname, "refs/bisect/");
+		starts_with(refname, "refs/bisect/") ||
+		starts_with(refname, "refs/rewritten/");
 }
 
 static int is_pseudoref_syntax(const char *refname)
diff --git a/t/t3430-rebase-recreate-merges.sh b/t/t3430-rebase-recreate-merges.sh
index b5ea4130bb5..5295bb03dc0 100755
--- a/t/t3430-rebase-recreate-merges.sh
+++ b/t/t3430-rebase-recreate-merges.sh
@@ -143,4 +143,18 @@ test_expect_success 'with a branch tip that was cherry-picked already' '
 	EOF
 '
 
+test_expect_success 'refs/rewritten/* is worktree-local' '
+	git worktree add wt &&
+	cat >wt/script-from-scratch <<-\EOF &&
+	label xyz
+	exec GIT_DIR=../.git git rev-parse --verify refs/rewritten/xyz >a || :
+	exec git rev-parse --verify refs/rewritten/xyz >b
+	EOF
+
+	test_config -C wt sequence.editor \""$PWD"/replace-editor.sh\" &&
+	git -C wt rebase -i HEAD &&
+	test_must_be_empty wt/a &&
+	test_cmp_rev HEAD "$(cat wt/b)"
+'
+
 test_done
-- 
2.16.1.windows.1


