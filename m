From: =?iso-8859-1?q?L=E9na=EFc_Huard?= <lenaic@lhuard.fr.eu.org>
Subject: [PATCH] gitweb: provide a way to customize html headers
Date: Sun, 16 Oct 2011 22:56:41 +0200
Message-ID: <201110162256.41431.lenaic@lhuard.fr.eu.org>
Mime-Version: 1.0
Content-Type: Text/Plain; charset=iso-8859-1
Content-Transfer-Encoding: QUOTED-PRINTABLE
To: git@vger.kernel.org
X-From: git-owner@vger.kernel.org Sun Oct 16 23:00:59 2011
Return-path: <git-owner@vger.kernel.org>
Envelope-to: gcvg-git-2@lo.gmane.org
Received: from vger.kernel.org ([209.132.180.67])
	by lo.gmane.org with esmtp (Exim 4.69)
	(envelope-from <git-owner@vger.kernel.org>)
	id 1RFXpK-00006V-Gb
	for gcvg-git-2@lo.gmane.org; Sun, 16 Oct 2011 23:00:58 +0200
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1751481Ab1JPU4o convert rfc822-to-quoted-printable (ORCPT
	<rfc822;gcvg-git-2@m.gmane.org>); Sun, 16 Oct 2011 16:56:44 -0400
Received: from freebox.lhuard.fr.eu.org ([88.182.161.122]:40164 "EHLO
	coruscant.lhuard.fr.eu.org" rhost-flags-OK-OK-OK-FAIL)
	by vger.kernel.org with ESMTP id S1751188Ab1JPU4n convert rfc822-to-8bit
	(ORCPT <rfc822;git@vger.kernel.org>);
	Sun, 16 Oct 2011 16:56:43 -0400
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=lhuard.fr.eu.org; s=dkim;
	h=Message-Id:Content-Transfer-Encoding:Content-Type:MIME-Version:Date:Subject:To:From; bh=OAaFPIW1HiCS0Nqax/bQdx8dBR8CYVbg11WAAaYeryo=;
	b=YTNGKSU3Z1ex7s2PoX6cQngY/E0reeVViTgR1BJ7l/w1sYXPZG5aeiHDZsEKYj09SJk6OoNEZylSl4UKWDVRktb4b1XoNQi2VFR4/44tPaaPymsTIUwr7VAbintOkMMV6KBwUUvbdfvCU0L8PKAZHANKjZdL42ygYiYVVdw0Wf0=;
Received: from lenaic by coruscant.lhuard.fr.eu.org with local (Exim 4.76)
	(envelope-from <lenaic@lhuard.fr.eu.org>)
	id 1RFXlB-0003LL-HZ
	for git@vger.kernel.org; Sun, 16 Oct 2011 22:56:41 +0200
User-Agent: KMail/1.13.7 (Linux/3.0.0-2-amd64; KDE/4.6.5; x86_64; ; )
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <http://permalink.gmane.org/gmane.comp.version-control.git/183735>

This allows web sites to add some specific html headers to the pages
generated by gitweb.

The new variable $site_htmlheader can be set to a filename the content
of which will be inserted at the end of the <head> section of each
page generated by gitweb.

Signed-off-by: L=E9na=EFc Huard <lenaic@lhuard.fr.eu.org>
---
 gitweb/INSTALL     |    3 +++
 gitweb/Makefile    |    2 ++
 gitweb/gitweb.perl |    7 +++++++
 t/gitweb-lib.sh    |    1 +
 4 files changed, 13 insertions(+), 0 deletions(-)

diff --git a/gitweb/INSTALL b/gitweb/INSTALL
index f5efe74..e23eafa 100644
--- a/gitweb/INSTALL
+++ b/gitweb/INSTALL
@@ -130,6 +130,9 @@ You can specify the following configuration variabl=
es when building GIT:
    Points to an .html file which is included on the gitweb project
    overview page ('projects_list' view), if it exists.  Relative to
    gitweb.cgi script.  [Default: indextext.html]
+ * GITWEB_SITE_HTMLHEADER
+   Filename of html code to include in the <head> section of each page=
=2E
+   Relative to gitweb.cgi script.  [No default]
  * GITWEB_SITE_HEADER
    Filename of html text to include at top of each page.  Relative to
    gitweb.cgi script.  [No default]
diff --git a/gitweb/Makefile b/gitweb/Makefile
index 1c85b5f..ecfb311 100644
--- a/gitweb/Makefile
+++ b/gitweb/Makefile
@@ -34,6 +34,7 @@ GITWEB_CSS =3D static/gitweb.css
 GITWEB_LOGO =3D static/git-logo.png
 GITWEB_FAVICON =3D static/git-favicon.png
 GITWEB_JS =3D static/gitweb.js
+GITWEB_SITE_HTMLHEADER =3D
 GITWEB_SITE_HEADER =3D
 GITWEB_SITE_FOOTER =3D
 HIGHLIGHT_BIN =3D highlight
@@ -144,6 +145,7 @@ GITWEB_REPLACE =3D \
        -e 's|++GITWEB_LOGO++|$(GITWEB_LOGO)|g' \
        -e 's|++GITWEB_FAVICON++|$(GITWEB_FAVICON)|g' \
        -e 's|++GITWEB_JS++|$(GITWEB_JS)|g' \
+       -e 's|++GITWEB_SITE_HTMLHEADER++|$(GITWEB_SITE_HTMLHEADER)|g' \
        -e 's|++GITWEB_SITE_HEADER++|$(GITWEB_SITE_HEADER)|g' \
        -e 's|++GITWEB_SITE_FOOTER++|$(GITWEB_SITE_FOOTER)|g' \
        -e 's|++HIGHLIGHT_BIN++|$(HIGHLIGHT_BIN)|g'
diff --git a/gitweb/gitweb.perl b/gitweb/gitweb.perl
index 85d64b2..63b0115 100755
--- a/gitweb/gitweb.perl
+++ b/gitweb/gitweb.perl
@@ -85,6 +85,8 @@ our $home_link_str =3D "++GITWEB_HOME_LINK_STR++";
 our $site_name =3D "++GITWEB_SITENAME++"
                  || ($ENV{'SERVER_NAME'} || "Untitled") . " Git";
=20
+# filename of html code to include in the <head> section of each page
+our $site_htmlheader =3D "++GITWEB_SITE_HTMLHEADER++";
 # filename of html text to include at top of each page
 our $site_header =3D "++GITWEB_SITE_HEADER++";
 # html text to include at home page
@@ -3879,6 +3881,11 @@ EOF
                print "<base href=3D\"".esc_url($base_url)."\" />\n";
        }
        print_header_links($status);
+
+       if (defined $site_htmlheader && -f $site_htmlheader) {
+               insert_file($site_htmlheader);
+       }
+
        print "</head>\n" .
              "<body>\n";
=20
diff --git a/t/gitweb-lib.sh b/t/gitweb-lib.sh
index 292753f..cfe5d74 100644
--- a/t/gitweb-lib.sh
+++ b/t/gitweb-lib.sh
@@ -16,6 +16,7 @@ our \$projectroot =3D "$safe_pwd";
 our \$project_maxdepth =3D 8;
 our \$home_link_str =3D 'projects';
 our \$site_name =3D '[localhost]';
+our \$site_htmlheader =3D '';
 our \$site_header =3D '';
 our \$site_footer =3D '';
 our \$home_text =3D 'indextext.html';
--=20
1.7.7
