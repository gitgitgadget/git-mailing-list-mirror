From: Peter Stuge <peter@stuge.se>
Subject: Re: [PATCH] gitweb: Add js=1 before an URI fragment to fix line
	number links
Date: Mon, 26 Sep 2011 21:46:39 +0200
Message-ID: <20110926194639.25339.qmail@stuge.se>
References: <1317060642-25488-1-git-send-email-peter@stuge.se> <7v62kf2jf4.fsf@alter.siamese.dyndns.org>
Mime-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Cc: git@vger.kernel.org
To: Junio C Hamano <gitster@pobox.com>
X-From: git-owner@vger.kernel.org Mon Sep 26 21:47:01 2011
Return-path: <git-owner@vger.kernel.org>
Envelope-to: gcvg-git-2@lo.gmane.org
Received: from vger.kernel.org ([209.132.180.67])
	by lo.gmane.org with esmtp (Exim 4.69)
	(envelope-from <git-owner@vger.kernel.org>)
	id 1R8H8k-0002va-Rs
	for gcvg-git-2@lo.gmane.org; Mon, 26 Sep 2011 21:46:59 +0200
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1753102Ab1IZTqn (ORCPT <rfc822;gcvg-git-2@m.gmane.org>);
	Mon, 26 Sep 2011 15:46:43 -0400
Received: from foo.stuge.se ([212.116.89.98]:58264 "HELO foo.stuge.se"
	rhost-flags-OK-OK-OK-OK) by vger.kernel.org with SMTP
	id S1752741Ab1IZTqm (ORCPT <rfc822;git@vger.kernel.org>);
	Mon, 26 Sep 2011 15:46:42 -0400
Received: (qmail 25340 invoked by uid 501); 26 Sep 2011 19:46:39 -0000
Content-Disposition: inline
In-Reply-To: <7v62kf2jf4.fsf@alter.siamese.dyndns.org>
Sender: git-owner@vger.kernel.org
Precedence: bulk
List-ID: <git.vger.kernel.org>
X-Mailing-List: git@vger.kernel.org
Archived-At: <http://permalink.gmane.org/gmane.comp.version-control.git/182157>

Junio C Hamano wrote:
> > Signed-off-by: Peter Stuge <peter@stuge.se>
> 
> Care to elaborate a bit more please?

Okey. I thought subject together with change would be clear enough. :)


> Explanation of what you are fixing is totally lacking.

The subject sums it up, if briefly.


> What happens with the current code, why it is wrong, and how the
> updated pattern improves the result in what way?

Current code generates links to line numbers like ../file.c#l1234;js=1

It is wrong because a URI fragment always goes at the end.

The updated pattern improves this by treating # like end of string,
to detect js=1 also before # and not only at end of string.

The updated code improves this by injecting [?;]js=1 before # if
one exists, or at end of string (like before) otherwise.


> > -var jsExceptionsRe = /[;?]js=[01]$/;
> > +var jsExceptionsRe = /[;?]js=[01](#.*)?$/;
..
> > -		if (!jsExceptionsRe.test(link)) { // =~ /[;?]js=[01]$/;
> > -			link.href +=
> > -				(link.href.indexOf('?') === -1 ? '?' : ';') + 'js=1';
> > +		if (!jsExceptionsRe.test(link)) { // =~ /[;?]js=[01](#.*)?$/;
> > +			link.href = link.href.replace(/(#|$)/,
> > +				(link.href.indexOf('?') === -1 ? '?' : ';') + 'js=1$1');

To test how this works you can try it on

http://git.libusb.org/?p=libusb.git;a=blob;f=COPYING

where the change is in production. Compare the line number links with
those generated by another gitweb with javascript-actions enabled.


//Peter
